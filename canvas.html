<body>
<table>
  <tr>
    <th>Origin</th><td id="Origin">12,34</td>
    <th>Scale</th><td id="Scale">1/200</td>
  </tr>
</table>
<canvas id="Canvas" width="600" height="600" style="height:600px;width:600px;">
</canvas>
</body>
<script>
	
	function augmentImageData(o){
	  o.getPixel=function(x,y){
	     var i=(x+y*this.width)*4;
	     return {R:this.data[i],
	             G:this.data[i+1],
	             B:this.data[i+2],
	             A:this.data[i+3]
	
	            }
	  }
	  o.setPixel=function(x,y,c){
	     var i=(x+y*this.width)*4;
	     this.data[i]=c.R;
	     this.data[i+1]=c.G;
	     this.data[i+2]=c.B;
	     this.data[i+3]=c.A;
	  }
	}
	
	var c = document.getElementById("Canvas");
	
	var elemLeft = c.offsetLeft,
	   elemTop = c.offsetTop,
	   context = c.getContext('2d');
	 
	 
	var max_iteration=0;
	var start_x= -2;
	var stop_x= 1;
	var start_y= -1.5;
	var stop_y= 1.5;
	   
	var Origin= document.getElementById("Origin");
	
	var Scale= document.getElementById("Scale");
	 

	   
	// Add event listener for `move` events.
	c.addEventListener('mousemove', function(event) {
	   var x = event.pageX - elemLeft,
	       y = event.pageY - elemTop;
	
		console.log('Moved at ' + x + ',' + y + '[' +
		(start_x + ((x / c.width) * (stop_x - start_x))) + ',' + 
		(start_y + ((y / c.height) * (stop_y - start_y)))
+ ']'
		);
	
	}, false);

	   
	// Add event listener for `click` events.
	c.addEventListener('click', function(event) {
	   var x = event.pageX - elemLeft,
	       y = event.pageY - elemTop;
	
		var new_x= (start_x + ((x / c.width) * (stop_x - start_x)));
		var new_y= (start_y + ((y /c.height) * (stop_y - start_y)));

		console.log('Clicked at ' + x + ',' + y + '[' + new_x + ',' + new_y  + ']');

		var new_width= (stop_x - start_x)/2;
		start_x= new_x - new_width/2;
		stop_x= new_x + new_width/2;
		
		var new_height= (stop_y - start_y)/2;
		start_y= new_y - new_height/2;
		stop_y= new_y + new_height/2;
	
		max_iteration= 0;
		
		Origin.innerHTML= '('+ ((stop_x - start_x) / 2) + ',' + ((stop_y - start_y) / 2) + ')';   
		Scale.innerHTML= ' ' + 1 / ((stop_x - start_x) / c.width);  
		
		mandelbrot( context, start_x, stop_x, start_y, stop_y, c.width, c.height, 1000);
	
	}, false);
	
	mandelbrot( context, start_x, stop_x, start_y, stop_y, c.width, c.height, 1000);
	
	/**
	* Converts an HSL color value to RGB. Conversion formula
	* adapted from http://en.wikipedia.org/wiki/HSL_color_space.
	* Assumes h, s, and l are contained in the set [0, 1] and
	* returns r, g, and b in the set [0, 255].
	*
	* @param   {number}  h       The hue
	* @param   {number}  s       The saturation
	* @param   {number}  l       The lightness
	* @return  {Array}           The RGB representation
	*/
	function hslToRgb(h, s, l){
	   var r, g, b;
	
	   if(s == 0){
	       r = g = b = l; // achromatic
	   }else{
	       var hue2rgb = function hue2rgb(p, q, t){
	           if(t < 0) t += 1;
	           if(t > 1) t -= 1;
	           if(t < 1/6) return p + (q - p) * 6 * t;
	           if(t < 1/2) return q;
	           if(t < 2/3) return p + (q - p) * (2/3 - t) * 6;
	           return p;
	       }
	
	       var q = l < 0.5 ? l * (1 + s) : l + s - l * s;
	       var p = 2 * l - q;
	       r = hue2rgb(p, q, h + 1/3);
	       g = hue2rgb(p, q, h);
	       b = hue2rgb(p, q, h - 1/3);
	   }
	
	   return [Math.round(r * 255), Math.round(g * 255), Math.round(b * 255)];
	}
	
	function escapeTime( x, y, max_iteration)
	{
	   var px = 0.0
	   var py = 0.0
	   var iteration = 0
	   while (px*px + py*py < 2*2  &&  iteration < max_iteration) {
	     var xtemp = px*px - py*py + x
	     py = 2*px*py + y
	     px = xtemp
	     iteration = iteration + 1
	   }
	
	  time = iteration / max_iteration;
	  
	  //console.log( iteration);
	
	 return iteration / max_iteration;
	}
	
	
	/**
	*	mandelbrot(
	*		context,
	*		centre_x, centre_y,
	*		pixels_x, pixels_y,
	*		scale)
	*
	*	Draw the mandelbrot set at (centre_x, centre_y) 
	*	over a canvas of pixel dimensions (pixels_x, pixels_y),
	*	with scale s
	*	
	*	e.g. mandelbrot( -0.5, 0, 600, 600, 1/200) plots the classic double cardioid
	*	from (-0.5 - 600/2 * 1/200, 0 - 600/2 * 1/200) to (-0.5 + 600/2 * 1/200, 0 + 600/2 * 1/200)
	*	i.e. (-2, -1.75) to (1,1.75)
	*/	 
	
	function mandelbrot( context, start_x, stop_x, start_y, stop_y, pixels_x, pixels_y, max_iteration)
	{
	
	var ImDat=context.createImageData(pixels_x, pixels_y);
	augmentImageData(ImDat);
	
	var delta_x= stop_x - start_x;
	var delta_y= stop_y - start_y;
	var inc_x= delta_x / pixels_x;
	var inc_y= delta_y / pixels_y;
	
	for(var x=0; x < pixels_x; x++){
	 //console.log( "Col " + x);
	 for (var y = 0; y < pixels_y; y++) {
	 	
	 	var time= escapeTime( start_x + inc_x * x, start_y + inc_y * y, max_iteration);
	 	
	 	//var time = y / ImDat.height;
	 	
	 	var rgb = (time == 1 ? [0,0,0] : hslToRgb( time, 0.75, 0.5 ))
	    					
	   ImDat.setPixel(x, y, {
	                         R: rgb[0],
	                         G: rgb[1],
	                         B: rgb[2],
	                         A: 255});
    }
	
	
	   context.putImageData(ImDat,0,0);
	}
	}
</script>
